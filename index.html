<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>موقع المسلم</title>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c5e8a;
            --secondary-color: #3a9ad9;
            --accent-color: #e6b31e;
            --light-color: #f5f5f5;
            --dark-color: #333;
            --prayer-time-bg: #2c5e8a;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Rubik', sans-serif;
        }
        
        body {
            background-color: var(--light-color);
            color: var(--dark-color);
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            border-radius: 15px 15px 0 0;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .date-display {
            background-color: var(--secondary-color);
            color: white;
            padding: 10px;
            text-align: center;
            font-size: 16px;
        }
        
        .prayer-times {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            padding: 15px;
            background-color: white;
        }
        
        .prayer-card {
            background-color: var(--prayer-time-bg);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .prayer-card.active {
            background-color: var(--accent-color);
            transform: scale(1.05);
        }
        
        .prayer-name {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .prayer-time {
            font-size: 24px;
            font-weight: 600;
        }
        
        .features {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            padding: 20px;
            background-color: white;
        }
        
        .feature-card {
            background-color: var(--light-color);
            border-radius: 10px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }
        
        .feature-icon {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .feature-name {
            font-size: 14px;
            font-weight: 500;
        }
        
        .bottom-nav {
            display: flex;
            justify-content: space-around;
            padding: 15px;
            background-color: white;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .nav-item {
            text-align: center;
            cursor: pointer;
        }
        
        .nav-icon {
            font-size: 20px;
            color: var(--primary-color);
        }
        
        .nav-text {
            font-size: 12px;
            margin-top: 5px;
        }
        
        .hijri-date {
            font-size: 14px;
            margin-top: 5px;
            color: #e6b31e;
        }
        
        /* نمط الإشعارات */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
            max-width: 300px;
            animation: slideIn 0.5s forwards;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .notification-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .notification-close {
            position: absolute;
            top: 5px;
            left: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        /* نمط شاشة التحميل */
        .loading {
            text-align: center;
            padding: 20px;
            color: var(--primary-color);
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid var(--light-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>موقع المسلم</h1>
            <div class="hijri-date" id="hijriDate">جاري التحميل...</div>
        </header>
        
        <div class="date-display" id="dateDisplay">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>جاري تحديد موقعك وجلب مواقيت الصلاة...</p>
            </div>
        </div>
        
        <div class="prayer-times">
            <div class="prayer-card">
                <div class="prayer-name">الفجر</div>
                <div class="prayer-time" id="fajr">--:--</div>
            </div>
            <div class="prayer-card">
                <div class="prayer-name">الشروق</div>
                <div class="prayer-time" id="sunrise">--:--</div>
            </div>
            <div class="prayer-card">
                <div class="prayer-name">الظهر</div>
                <div class="prayer-time" id="dhuhr">--:--</div>
            </div>
            <div class="prayer-card">
                <div class="prayer-name">العصر</div>
                <div class="prayer-time" id="asr">--:--</div>
            </div>
            <div class="prayer-card">
                <div class="prayer-name">المغرب</div>
                <div class="prayer-time" id="maghrib">--:--</div>
            </div>
            <div class="prayer-card">
                <div class="prayer-name">isha">العشاء</div>
                <div class="prayer-time" id="isha">--:--</div>
            </div>
        </div>
        
        <div class="features">
            <div class="feature-card">
                <div class="feature-icon"><i class="fas fa-moon"></i></div>
                <div class="feature-name">التقويم الهجري</div>
            </div>
            <div class="feature-card">
                <div class="feature-icon"><i class="fas fa-kaaba"></i></div>
                <div class="feature-name">اتجاه القبلة</div>
            </div>
            <div class="feature-card">
                <div class="feature-icon"><i class="fas fa-hands-praying"></i></div>
                <div class="feature-name">أذكار المسلم</div>
            </div>
            <div class="feature-card">
                <div class="feature-icon"><i class="fas fa-book-quran"></i></div>
                <div class="feature-name">القرآن الكريم</div>
            </div>
            <div class="feature-card">
                <div class="feature-icon"><i class="fas fa-mosque"></i></div>
                <div class="feature-name">المساجد القريبة</div>
            </div>
            <div class="feature-card">
                <div class="feature-icon"><i class="fas fa-pray"></i></div>
                <div class="feature-name">تفسير الأحلام</div>
            </div>
        </div>
        
        <div class="bottom-nav">
            <div class="nav-item">
                <i class="fas fa-home nav-icon"></i>
                <div class="nav-text">الرئيسية</div>
            </div>
            <div class="nav-item">
                <i class="fas fa-calendar-alt nav-icon"></i>
                <div class="nav-text">التقويم</div>
            </div>
            <div class="nav-item">
                <i class="fas fa-compass nav-icon"></i>
                <div class="nav-text">القبلة</div>
            </div>
            <div class="nav-item">
                <i class="fas fa-book nav-icon"></i>
                <div class="nav-text">القرآن</div>
            </div>
        </div>
    </div>
    
    <!-- الإشعار -->
    <div class="notification" id="prayerNotification">
        <span class="notification-close" onclick="closeNotification()">✕</span>
        <div class="notification-title" id="notificationTitle">اقتربت صلاة الفجر</div>
        <div id="notificationMessage">باقي على صلاة الفجر 15 دقيقة، استعد للصلاة</div>
    </div>
    
    <script>
        // متغير لحفظ الموقع الجغرافي
        let userLocation = {
            latitude: null,
            longitude: null,
            city: '',
            country: ''
        };

        // دالة للحصول على الموقع الجغرافي
        async function getUserLocation() {
            return new Promise((resolve, reject) => {
                if ("geolocation" in navigator) {
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            userLocation.latitude = position.coords.latitude;
                            userLocation.longitude = position.coords.longitude;
                            resolve(userLocation);
                        },
                        error => {
                            // في حالة رفض الموقع، استخدم موقع افتراضي (القاهرة، مصر)
                            console.warn('تم رفض تحديد الموقع، استخدام الموقع الافتراضي');
                            userLocation.latitude = 30.0444;
                            userLocation.longitude = 31.2357;
                            userLocation.city = 'القاهرة';
                            userLocation.country = 'مصر';
                            resolve(userLocation);
                        }
                    );
                } else {
                    // المتصفح لا يدعم تحديد الموقع
                    userLocation.latitude = 30.0444;
                    userLocation.longitude = 31.2357;
                    userLocation.city = 'القاهرة';
                    userLocation.country = 'مصر';
                    resolve(userLocation);
                }
            });
        }

        // دالة لجلب مواقيت الصلاة من Aladhan API
        async function fetchPrayerTimes() {
            try {
                // الحصول على الموقع الجغرافي أولاً
                await getUserLocation();
                
                // جلب البيانات من Aladhan API
                // method=4 يستخدم طريقة حساب جامعة أم القرى (مناسبة للدول العربية)
                // يمكن تغيير method حسب البلد:
                // method=5 للمعهد الإسلامي للعلوم في جامعة كراتشي
                // method=2 للجمعية الإسلامية لأمريكا الشمالية
                const url = `https://api.aladhan.com/v1/timings?latitude=${userLocation.latitude}&longitude=${userLocation.longitude}&method=4`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.code === 200) {
                    const timings = data.data.timings;
                    const date = data.data.date;
                    const meta = data.data.meta;
                    
                    // تحديث مواقيت الصلاة
                    document.getElementById('fajr').textContent = formatTime(timings.Fajr);
                    document.getElementById('sunrise').textContent = formatTime(timings.Sunrise);
                    document.getElementById('dhuhr').textContent = formatTime(timings.Dhuhr);
                    document.getElementById('asr').textContent = formatTime(timings.Asr);
                    document.getElementById('maghrib').textContent = formatTime(timings.Maghrib);
                    document.getElementById('isha').textContent = formatTime(timings.Isha);
                    
                    // تحديث التاريخ الميلادي
                    const gregorianDate = `${date.gregorian.day} ${date.gregorian.month.ar} ${date.gregorian.year}`;
                    
                    // الحصول على اسم المدينة من timezone
                    const cityName = meta.timezone.split('/').pop().replace(/_/g, ' ');
                    
                    document.getElementById('dateDisplay').innerHTML = 
                        `${gregorianDate} - ${cityName}`;
                    
                    // تحديث التاريخ الهجري
                    const hijriDate = `${date.hijri.day} ${date.hijri.month.ar} ${date.hijri.year} هـ - ${date.hijri.weekday.ar}`;
                    document.getElementById('hijriDate').textContent = hijriDate;
                    
                    // تحديد الصلاة الحالية التي عليها الدور
                    highlightCurrentPrayer(timings);
                    
                    // جدولة الإشعارات للصلاة
                    schedulePrayerNotifications(timings);
                    
                } else {
                    throw new Error('فشل في جلب البيانات من API');
                }
                
            } catch (error) {
                console.error('حدث خطأ في جلب مواقيت الصلاة:', error);
                // استخدام البيانات الافتراضية في حالة الخطأ
                setDefaultPrayerTimes();
            }
        }
        
        // دالة لتنسيق الوقت (تحويل من 24 ساعة إلى 12 ساعة إذا لزم الأمر)
        function formatTime(time24) {
            // إزالة الثواني إذا كانت موجودة
            return time24.substring(0, 5);
        }
        
        // دالة لتحديد الصلاة الحالية التي عليها الدور
        function highlightCurrentPrayer(timings) {
            // إزالة التنشيط من جميع البطاقات أولاً
            document.querySelectorAll('.prayer-card').forEach(card => {
                card.classList.remove('active');
            });
            
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            // تحويل أوقات الصلاة إلى دقائق
            const prayerTimes = {
                Fajr: convertTimeToMinutes(timings.Fajr),
                Sunrise: convertTimeToMinutes(timings.Sunrise),
                Dhuhr: convertTimeToMinutes(timings.Dhuhr),
                Asr: convertTimeToMinutes(timings.Asr),
                Maghrib: convertTimeToMinutes(timings.Maghrib),
                Isha: convertTimeToMinutes(timings.Isha)
            };
            
            // تحديد الصلاة الحالية التي عليها الدور
            let currentPrayer = '';
            
            // الفجر: من وقت الفجر إلى الشروق
            if (currentTime >= prayerTimes.Fajr && currentTime < prayerTimes.Sunrise) {
                currentPrayer = 'Fajr';
            } 
            // الظهر: من وقت الظهر إلى العصر
            else if (currentTime >= prayerTimes.Dhuhr && currentTime < prayerTimes.Asr) {
                currentPrayer = 'Dhuhr';
            } 
            // العصر: من وقت العصر إلى المغرب
            else if (currentTime >= prayerTimes.Asr && currentTime < prayerTimes.Maghrib) {
                currentPrayer = 'Asr';
            } 
            // المغرب: من وقت المغرب إلى العشاء
            else if (currentTime >= prayerTimes.Maghrib && currentTime < prayerTimes.Isha) {
                currentPrayer = 'Maghrib';
            } 
            // العشاء: من وقت العشاء إلى الفجر
            else if (currentTime >= prayerTimes.Isha || currentTime < prayerTimes.Fajr) {
                currentPrayer = 'Isha';
            }
            
            // تنشيط البطاقة المناسبة
            const prayerCards = document.querySelectorAll('.prayer-card');
            switch(currentPrayer) {
                case 'Fajr':
                    prayerCards[0].classList.add('active');
                    break;
                case 'Dhuhr':
                    prayerCards[2].classList.add('active');
                    break;
                case 'Asr':
                    prayerCards[3].classList.add('active');
                    break;
                case 'Maghrib':
                    prayerCards[4].classList.add('active');
                    break;
                case 'Isha':
                    prayerCards[5].classList.add('active');
                    break;
            }
        }
        
        // دالة لجدولة إشعارات الصلاة
        function schedulePrayerNotifications(timings) {
            // إلغاء أي مؤقتات سابقة
            clearAllTimeouts();
            
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            // تحويل أوقات الصلاة إلى دقائق
            const prayerTimes = {
                Fajr: convertTimeToMinutes(timings.Fajr),
                Sunrise: convertTimeToMinutes(timings.Sunrise),
                Dhuhr: convertTimeToMinutes(timings.Dhuhr),
                Asr: convertTimeToMinutes(timings.Asr),
                Maghrib: convertTimeToMinutes(timings.Maghrib),
                Isha: convertTimeToMinutes(timings.Isha)
            };
            
            // جدولة إشعارات قبل كل صلاة بربع ساعة (15 دقيقة)
            scheduleNotification('الفجر', prayerTimes.Fajr - 15, currentTime);
            scheduleNotification('الظهر', prayerTimes.Dhuhr - 15, currentTime);
            scheduleNotification('العصر', prayerTimes.Asr - 15, currentTime);
            scheduleNotification('المغرب', prayerTimes.Maghrib - 15, currentTime);
            scheduleNotification('العشاء', prayerTimes.Isha - 15, currentTime);
        }
        
        // دالة لجدولة إشعار واحد
        function scheduleNotification(prayerName, notificationTime, currentTime) {
            // حساب الوقت المتبقي حتى الإشعار (بالمللي ثانية)
            let timeUntilNotification = (notificationTime - currentTime) * 60 * 1000;
            
            // إذا كان وقت الإشعار قد مضى اليوم، نجدوله لليوم التالي
            if (timeUntilNotification < 0) {
                timeUntilNotification += 24 * 60 * 60 * 1000; // أضف 24 ساعة
            }
            
            // جدولة الإشعار
            notificationTimeouts.push(setTimeout(() => {
                showNotification(`اقتربت صلاة ${prayerName}`, `باقي على صلاة ${prayerName} 15 دقيقة، استعد للصلاة`);
                
                // يمكنك هنا إضافة صوت للإشعار إذا أردت
                // new Audio('notification-sound.mp3').play();
                
            }, timeUntilNotification));
        }
        
        // مصفوفة لحفظ المؤقتات
        let notificationTimeouts = [];
        
        // دالة لإلغاء جميع المؤقتات
        function clearAllTimeouts() {
            notificationTimeouts.forEach(timeout => clearTimeout(timeout));
            notificationTimeouts = [];
        }
        
        // دالة لعرض الإشعار
        function showNotification(title, message) {
            const notification = document.getElementById('prayerNotification');
            document.getElementById('notificationTitle').textContent = title;
            document.getElementById('notificationMessage').textContent = message;
            
            notification.style.display = 'block';
            
            // إخفاء الإشعار تلقائياً بعد 5 ثواني
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }
        
        // دالة لإغلاق الإشعار يدوياً
        function closeNotification() {
            document.getElementById('prayerNotification').style.display = 'none';
        }
        
        // دالة لتحويل الوقت من نص إلى دقائق
        function convertTimeToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }
        
        // دالة للبيانات الافتراضية في حالة الخطأ
        function setDefaultPrayerTimes() {
            document.getElementById('dateDisplay').innerHTML = 'تعذر تحديد الموقع - القاهرة، مصر';
            
            const defaultTimes = {
                Fajr: '03:45',
                Sunrise: '05:19',
                Dhuhr: '11:54',
                Asr: '15:31',
                Maghrib: '18:30',
                Isha: '19:53'
            };
            
            document.getElementById('fajr').textContent = defaultTimes.Fajr;
            document.getElementById('sunrise').textContent = defaultTimes.Sunrise;
            document.getElementById('dhuhr').textContent = defaultTimes.Dhuhr;
            document.getElementById('asr').textContent = defaultTimes.Asr;
            document.getElementById('maghrib').textContent = defaultTimes.Maghrib;
            document.getElementById('isha').textContent = defaultTimes.Isha;
            
            highlightCurrentPrayer(defaultTimes);
            schedulePrayerNotifications(defaultTimes);
        }
        
        // جلب البيانات عند تحميل الصفحة
        window.addEventListener('DOMContentLoaded', fetchPrayerTimes);
        
        // تحديث البيانات كل ساعة
        setInterval(fetchPrayerTimes, 3600000);
        
        // تحديث تحديد الصلاة الحالية كل دقيقة
        setInterval(() => {
            const timings = {
                Fajr: document.getElementById('fajr').textContent,
                Sunrise: document.getElementById('sunrise').textContent,
                Dhuhr: document.getElementById('dhuhr').textContent,
                Asr: document.getElementById('asr').textContent,
                Maghrib: document.getElementById('maghrib').textContent,
                Isha: document.getElementById('isha').textContent
            };
            highlightCurrentPrayer(timings);
        }, 60000);
    </script>
</body>
</html>
